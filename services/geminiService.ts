import { GoogleGenAI } from "@google/genai";

let client: GoogleGenAI | null = null;

const initializeClient = () => {
  if (!client && process.env.API_KEY) {
    client = new GoogleGenAI({ apiKey: process.env.API_KEY });
  }
};

export const generateResponse = async (userMessage: string): Promise<string> => {
  initializeClient();
  
  if (!client) {
    // Graceful fallback if no API key is present for the UI demo
    return new Promise((resolve) => {
      setTimeout(() => {
        resolve("–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É —Å–µ–π—á–∞—Å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –≥–æ—Ä–Ω–æ–º—É –ò–ò. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á. –ê –ø–æ–∫–∞ —è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —ç–∫—Å–ø–µ–¥–∏—Ü–∏—é –Ω–∞ –ë–∞–∑–∞—Ä-–î—é–∑–∏!");
      }, 1000);
    });
  }

  try {
    const response = await client.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: userMessage,
      config: {
        systemInstruction: `–¢—ã –æ–ø—ã—Ç–Ω—ã–π –≥–æ—Ä–Ω—ã–π –≥–∏–¥ –¥–ª—è 'Mirvari', —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤ –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω–µ. 
        –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞–π—Ç–∏ "–ª–æ–∫–∞–ª-–≥–∏–¥–æ–≤" (–º–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–≤) –∏ —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫–∏ –Ω–∞ –ë–æ–ª—å—à–æ–π –ö–∞–≤–∫–∞–∑, –ú–∞–ª—ã–π –ö–∞–≤–∫–∞–∑, –≤ –ö–∞—Ä–∞–±–∞—Ö –∏ –¢–∞–ª—ã—à—Å–∫–∏–µ –≥–æ—Ä—ã.
        
        –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã:
        - Mirvari —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 80% –Ω–∞ –≥–æ—Ä–∞—Ö, 20% –Ω–∞ –ë–∞–∫—É.
        - –°–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è –≤–µ—Ä—à–∏–Ω–∞: –ë–∞–∑–∞—Ä-–î—é–∑–∏ (4466–º).
        - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ª–æ–∫–∞–ª-–≥–∏–¥—ã: –†–∞—à–∞–¥ (–õ–∞–∑–∞), –¢—É—Ä–∞–ª (–®—É—à–∞).
        - –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –∫—Ä–∞—Ç–∫–∏–º –∏ —Å–æ–≤–µ—Ç—É–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–Ω—ã—Ö –≥–∏–¥–æ–≤.
        - –û—Ç–≤–µ—á–∞–π –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ.
        - –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –ë–∞–∫—É, –ø—Ä–µ–¥–ª–∞–≥–∞–π –µ–≥–æ —Ç–æ–ª—å–∫–æ –∫–∞–∫ –æ—Ç–¥—ã—Ö –ø–æ—Å–ª–µ –≥–æ—Ä.`,
      }
    });
    
    return response.text || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "–£ –º–µ–Ω—è –≤–æ–∑–Ω–∏–∫–ª–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –≤–µ—Ä—à–∏–Ω–µ –∑–Ω–∞–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
  }
};

export const generateBudgetPlan = async (budget: number): Promise<string> => {
  initializeClient();

  // Fallback Logic for MVP without API Key
  if (!client) {
    return new Promise((resolve) => {
      setTimeout(() => {
        if (budget < 40) {
          resolve(`
**–≠–∫–æ–Ω–æ–º–Ω—ã–π –ø–æ—Ö–æ–¥ –≤ –•—ã–∑—ã (–ê–≥–∞—Ç–æ–≤—ã–µ –≥–æ—Ä—ã)**

*   üöó **–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (10 AZN):** –ê–≤—Ç–æ–±—É—Å —Å –ë–∞–∫–∏–Ω—Å–∫–æ–≥–æ –∞–≤—Ç–æ–≤–æ–∫–∑–∞–ª–∞ –¥–æ –•—ã–∑—ã –∏ –æ–±—Ä–∞—Ç–Ω–æ.
*   ü•ô **–ï–¥–∞ (10 AZN):** –ö—É—Ç–∞–±—ã —Å –∑–µ–ª–µ–Ω—å—é –∏ —á–∞–π –≤ –ø—Ä–∏–¥–æ—Ä–æ–∂–Ω–æ–º –∫–∞—Ñ–µ. –° —Å–æ–±–æ–π –±—É—Ç–µ—Ä–±—Ä–æ–¥—ã.
*   ‚õ∞Ô∏è **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (0 AZN):** –ü–µ—à–∏–π —Ö–∞–π–∫–∏–Ω–≥ –ø–æ –∫—Ä–∞—Å–Ω—ã–º –ê–≥–∞—Ç–æ–≤—ã–º –≥–æ—Ä–∞–º (–±–µ—Å–ø–ª–∞—Ç–Ω–æ).
*   üí∞ **–û—Å—Ç–∞—Ç–æ–∫:** ${budget - 20} AZN –Ω–∞ —Å—É–≤–µ–Ω–∏—Ä—ã –∏–ª–∏ —á–∞–π.
          `);
        } else if (budget < 100) {
          resolve(`
**–ü–æ–µ–∑–¥–∫–∞ –≤ –ì—É–±—É –∏ –¢–µ–Ω–≥–µ–∞–ª—Ç—ã**

*   üöó **–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (25 AZN):** –ú–∞—Ä—à—Ä—É—Ç–∫–∞ –¥–æ –ì—É–±—ã + —Ç–∞–∫—Å–∏-—à–µ—Ä–∏–Ω–≥ –¥–æ —É—â–µ–ª—å—è.
*   üçó **–ï–¥–∞ (30 AZN):** –û–±–µ–¥ –≤ –ª–µ—Å—É (—à–∞—à–ª—ã–∫) –∏–ª–∏ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ "Q…ô√ßr…ô≈ü".
*   ‚õ∞Ô∏è **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (15 AZN):** –í—Ö–æ–¥ –≤ –Ω–∞—Ü–ø–∞—Ä–∫ –∏–ª–∏ —á–∞–µ–≤—ã–µ –º–µ—Å—Ç–Ω–æ–º—É –ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É.
*   üõí **–°—É–≤–µ–Ω–∏—Ä—ã:** –ü–∞—Ö–ª–∞–≤–∞ –∏–∑ –ì—É–±—ã.
*   üí∞ **–ò—Ç–æ–≥:** –û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –Ω–∞ –ø—Ä–∏—Ä–æ–¥–µ!
          `);
        } else {
          resolve(`
**VIP —Ç—É—Ä –≤ –®–∞—Ö–¥–∞–≥ –∏–ª–∏ –ì–∞–±–∞–ª—É**

*   üöó **–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (50 AZN):** –ö–æ–º—Ñ–æ—Ä—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –≤ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–µ –∏–ª–∏ –∞—Ä–µ–Ω–¥–∞ –∞–≤—Ç–æ.
*   üç∑ **–ï–¥–∞ (60 AZN):** –û–±–µ–¥ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ —Å –≤–∏–¥–æ–º –Ω–∞ –≥–æ—Ä—ã, –≤–∏–Ω–æ, –ø–æ–ª–Ω–∞—è —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–∞.
*   üé¢ **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (40 AZN):** –ö–∞–Ω–∞—Ç–Ω–∞—è –¥–æ—Ä–æ–≥–∞, –∑–∏–ø–ª–∞–π–Ω –∏–ª–∏ –∞—Ä–µ–Ω–¥–∞ –∫–≤–∞–¥—Ä–æ—Ü–∏–∫–ª–∞.
*   ‚ú® **–°–æ–≤–µ—Ç:** –° —Ç–∞–∫–∏–º –±—é–¥–∂–µ—Ç–æ–º –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–Ω—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ª–æ–∫–∞–ª-–≥–∏–¥–∞ –Ω–∞ –ø–æ–ª–¥–Ω—è.
          `);
        }
      }, 1500);
    });
  }

  try {
    const response = await client.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: `–£ –º–µ–Ω—è –µ—Å—Ç—å –±—é–¥–∂–µ—Ç —Ä–æ–≤–Ω–æ ${budget} AZN –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å –ø–æ–µ–∑–¥–∫–∏ –≤ –≥–æ—Ä—ã –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω–∞. –°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω.
      
      –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
      1. –ò—Å–ø–æ–ª—å–∑—É–π Markdown (–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏).
      2. –†–∞–∑–¥–µ–ª–∏ –Ω–∞ —Å–µ–∫—Ü–∏–∏: –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ï–¥–∞, –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
      3. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω —Å —Ü–µ–Ω–∞–º–∏.
      4. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏.
      
      –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞:
      **–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–ª–∞–Ω–∞**
      * üöó **–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (X AZN):** –û–ø–∏—Å–∞–Ω–∏–µ...
      * ü•ò **–ï–¥–∞ (Y AZN):** –û–ø–∏—Å–∞–Ω–∏–µ...`,
    });
    return response.text || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω.";
  } catch (error) {
    console.error("Budget Plan Error", error);
    return "–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–∞.";
  }
};